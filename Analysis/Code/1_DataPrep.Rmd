---
title: "DOM review: Data preparation"
output: html_document
---

## Summary

This document reads in the review spreadsheet and converts the fields to a usable format. It also checks each field for any possible input errors and indicates the offending paper to the user.

```{r Packages, include = FALSE}
library(tidyverse)
library(readxl)
library(knitr)
```

## Read-in
The review data spreadsheet is comprised of six sheets, unified by the shared 'Review ID' field.
- Study: Authorship and publication information
- Objectives and Inference: Purpose of the study and key outputs
- Species and Location: Taxa and geographic information
- Data collection: Sampling and survey methods
- Covariates: Estimated parameters and predictors used
- Modelling: Model selection and evaluation methods

Each must be read-in individually.
```{r Read spreadsheet, echo = FALSE}
# Load the spreadsheet as a list of dataframes (sheets)
spreadsheet_path <- "Spreadsheets/Stage2_Spreadsheet.xlsx"
spreadsheet <- map(excel_sheets(spreadsheet_path),
                   read_excel,
                   path = spreadsheet_path)
# Reapply sheet names
names(spreadsheet) <- excel_sheets(spreadsheet_path)
```


## Study
This sheet contains information on authorship and publication history.
```{r Process study, echo = FALSE}
study_sheet <- spreadsheet[["Study"]] %>%
  # Select only included papers
  filter(Status == "Complete") %>%
  # Coerce all journal names to uppercase
  mutate(Journal = toupper(Journal)) %>%
  # Convert each possible 'Authorship group` to binary TRUE/FALSE
  mutate(Author_NGO = str_detect(`Authorship groups`, "NGO"),
         Author_Government = str_detect(`Authorship groups`, "Government"),
         Author_Private = str_detect(`Authorship groups`, "Private"),
         Author_Academic = str_detect(`Authorship groups`, "Academic")) %>%
  # Select only necessary columns for analysis
  select(`Review ID`, Title, Journal, Year, `First author country`, 
         Author_NGO, Author_Government, Author_Private, Author_Academic, `Authorship groups`)

# Print head
kable(head(study_sheet))
```

Next, each column of the study sheet must be checked for possible errors
```{r Check study}
# Are there any journals whose titles should match but don't?
study_sheet %>% count(Journal) %>% arrange(-n)

# Are all country names correct?
study_sheet %>% count(`First author country`) %>% arrange(-n)

# Are all years between 2000-2022?
study_sheet %>% count(Year) %>% arrange(Year)

# Do all papers have at least one of the Authorship categories set to 'True'?
study_sheet %>% select(Author_NGO,Author_Academic,Author_Government,Author_Private)
```


## Objectives 
This sheet contains information on the authors' stated research objectives and whether their papers produced certain products (maps/predictions). This sheet is relatively simple and does not require checks.
```{r Process objectives, echo = FALSE}
objectives_sheet <- spreadsheet[["Objectives and Inference"]] %>%
  # Select only completed papers
  filter(Status == "Complete") %>%
  # Convert objective columns to TRUE/FALSE
  mutate(Obj_Methods = case_when(`Methods?` == "Y" ~ TRUE,
                                 `Methods?` == "N" ~ FALSE),
         Obj_Projections = case_when(`Future predictions?` == "Y" ~ TRUE,
                                     `Future predictions?` == "N" ~ FALSE),
         Obj_Spatial = case_when(`Spatial predictions?` == "Y" ~ TRUE,
                                 `Spatial predictions?` == "N" ~ FALSE),
         Obj_Trends = case_when(`Observing trends?` == "Y" ~ TRUE,
                                `Observing trends?` == "N" ~ FALSE),
         Obj_Hypothesis = case_when(`Hypothesis testing?` == "Y" ~ TRUE,
                                    `Hypothesis testing?` == "N" ~ FALSE)) %>%
  # Drop unneeded columns
  select(`Review ID`, Title, Obj_Methods, Obj_Projections, 
         Obj_Spatial, Obj_Trends, Obj_Hypothesis)

# Print first few rows
kable(head(objectives_sheet))
```


## Species and Location
This sheet describes the study species and area. Some papers with multi-species models may have multiple entries.
```{r Process Species/Location, echo = FALSE}
taxa_location_sheet <- spreadsheet[["Species and Location"]] %>%
  # Filter to included papers
  filter(Status == "Complete") %>%
  # Create binary threat columns
  mutate(Threat_HabitatLoss = str_detect(`Threat categories`, "HabitatLoss"),
         Threat_Exploitation = str_detect(`Threat categories`, "Exploitation"),
         Threat_ClimateChange = str_detect(`Threat categories`, "ClimateChange"),
         Threat_Invasives = str_detect(`Threat categories`, "Invasives"),
         Threat_Disease = str_detect(`Threat categories`, "Disease"),
         Threat_Disaster = str_detect(`Threat categories`, "Disturbance")) %>%
  # Split 'taxa keywords' column by commas
  separate_rows(`Taxa keywords`, sep = ", ") %>%
  # Split country column by commas
  separate_rows(Country, sep = ", ") %>%
  # Select only necessary fields
  select(`Review ID`, Title, Taxa, `Taxa keywords`, Number, 
         Threat_HabitatLoss, Threat_Exploitation, Threat_ClimateChange,
         Threat_Invasives, Threat_Disease, Threat_Disaster,
         Country, Continent, Realm, `Study Size`)
kable(head(taxa_location_sheet))
```

This section includes a few fields which require checks
```{r Check Species/Location, echo = FALSE}
# Are all taxa names appropriate?
unique(taxa_location_sheet$Taxa)

# Should any taxa categories be condensed or removed?
unique(taxa_location_sheet$`Taxa keywords`)

# Are all country names correct?
taxa_location_sheet %>% count(Country) %>% arrange(-n)
```


## Data collection
This sheet includes information on survey and sampling techniques
```{r Process Data Collection, echo = FALSE}
survey_sheet <- spreadsheet[["Data collection"]] %>%
  # Filter to included papers
  filter(Status == "Complete") %>% 
  # Split capture method and sampling method fields
  separate_rows(`Capture method`, sep = ", ") %>%
  separate_rows(`Sampling method`, sep = ", ") %>%
  # Split min/max number of primary occasions if present
  mutate(MinPrimary = str_split(`Number of primary occasions`, "-", simplify = TRUE)[,1],
         MaxPrimary = str_split(`Number of primary occasions`, "-", simplify = TRUE)[,2]) %>%
  mutate(MaxPrimary = case_when(MaxPrimary == "" ~ MinPrimary,
                                MaxPrimary != "" ~ MaxPrimary)) %>%
  # Repeat for secondary occasions
  mutate(MinSecondary = str_split(`Number of secondary occasions`, "-", simplify = TRUE)[,1],
         MaxSecondary = str_split(`Number of secondary occasions`, "-", simplify = TRUE)[,2]) %>%
  mutate(MaxSecondary = case_when(MaxSecondary == "" ~ MinSecondary,
                                  MaxSecondary != "" ~ MaxSecondary)) %>%
  # Coerce columns to numeric
  mutate(MinPrimary = as.numeric(MinPrimary),
         MaxPrimary = as.numeric(MaxPrimary),
         MinSecondary = as.numeric(MinSecondary),
         MaxSecondary = as.numeric(MaxSecondary),
         NumSites = as.numeric(`Number of sites`)) %>%
  # Select important fields
  select(`Review ID`, Title, `Study duration`, `Capture method`, 
         MinPrimary, MaxPrimary, MinSecondary, MaxSecondary,
         `Type site` = `Type of site`, NumSites,
         `Sampling method`)

kable(head(survey_sheet))
```

This section still needs to be checked for any input errors.
```{r Check Data Collection, echo = FALSE}

```


## Covariates
This section includes estimated parameters and covariates considered for inclusion

```{r Process covariates, echo = FALSE}
covariates_sheet <- spreadsheet[["Covariates"]] %>%
  # Filter down to only included papers
  filter(Status == "Complete") %>%
  # Note modifiers for parameters, then split them off from parameters
  mutate(MultiSpecies = case_when(str_detect(Parameter,"MS") ~ TRUE,
                                  !str_detect(Parameter, "MS") ~ FALSE),
         FalsePositive = case_when(str_detect(Parameter, "FP") & str_detect(Parameter, "Detection") ~ TRUE)) %>%
  mutate(Parameter = str_split(Parameter, "_", simplify = TRUE)[,1]) %>%
  # Split out each covariate
  separate_rows(`Categories`, sep =  ", ") %>%
  # Convert 'none' to NA
  separate(`Categories`, c("Category", "Scale", "Dynanimity"), sep = "_") %>%
  select(`Review ID`, Title, `Total covariates`, Parameter, Category, Scale, 
         Dynanimity, `Higher order`, `Interactive terms`,
         MultiSpecies, FalsePositive)

covariates_sheet$Category[covariates_sheet$Category %in% c("None", "NA")] <- NA
covariates_sheet$Category[covariates_sheet$Category == c("Topography")] <- "Topographic"
covariates_sheet$Category[covariates_sheet$Category == c("Hydrology")] <- "Hydrologic"

kable(head(covariates_sheet))
```





```{r Check covariates, echo = FALSE}
```

## Modelling
This contains information about the model selection and evaluation process
```{r Process modelling, echo = FALSE}
modelling_sheet <- spreadsheet[["Modelling"]] %>%
  filter(Status == "Complete") %>%
  separate_rows(`Selection category`, sep = ", ") %>%
  separate(`Selection category`, into = c("Select_Category", "Select_Type"), sep = "_") %>%
  select(`Review ID`, Title, Bayesian, Select_Category, Select_Type)

modelling_sheet$Select_Category[modelling_sheet$Select_Category == "APriori"] <- "Apriori"

```




```{r Save output, echo = FALSE}

reviewResults <- list(Study = study_sheet,
                      Objectives = objectives_sheet,
                      Taxa = taxa_location_sheet,
                      Survey = survey_sheet,
                      Covariates = covariates_sheet,
                      Modelling = modelling_sheet)

write_rds(reviewResults, "Analysis/Outputs/ReviewResults.rds")
```










